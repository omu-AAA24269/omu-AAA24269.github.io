<!DOCTYPE html>
<html>
    <head>
        <title>1.地図タイルを背景として表示する</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""
        />
        <script
            src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""
        >
            // マーカーをセット
            startMarker = L.marker([34.592331, 135.505276]).addTo(map).bindPopup("出発地（杉本）").openPopup();
            endMarker = L.marker([34.544865, 135.506274]).addTo(map).bindPopup("目的地（中百舌鳥）").openPopup();

            //  ルートを検索して描画
            const initUrl = `https://routing.openstreetmap.de/routed-car/route/v1/driving/${startMarker.getLatLng().lng},${startMarker.getLatLng().lat};${endMarker.getLatLng().lng},${endMarker.getLatLng().lat}?geometries=geojson&overview=full`;
            
            fetch(initUrl)
            .then(response => response.json())
            .then(json => {
                if(json.routes && json.routes.length > 0) {
                    routeLine = L.geoJSON(json.routes[0].geometry, {
                        color: 'blue', weight: 6, opacity: 0.7
                    }).addTo(map);
                    
                    // 距離と時間を表示
                    const dist = (json.routes[0].distance / 1000).toFixed(1);
                    const time = (json.routes[0].duration / 60).toFixed(0);
                    endMarker.bindPopup(`目的地（中百舌鳥）<br>距離: ${dist}km<br>時間: 約${time}分`).openPopup();
                }
            });
    </script>
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />
        <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>
        </head>
    <body>
        <div id="map" style="height: 80vh"></div>
        <script>
            // 地図インスタンスを初期化
            const map = L.map('map', {
                center: [34.544648, 135.506436], // 初期表示の地図中心の[緯度, 経度]
                zoom: 14, // 初期ズームレベル
            });
            // 背景レイヤーインスタンスを初期化
            const backgroundLayer = L.tileLayer(
                'https://tile.openstreetmap.org/{z}/{x}/{y}.png', // OSMのURLテンプレート
                {
                    maxZoom: 19,
                    attribution:
                        '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                },
            );
            // 地図インスタンスへレイヤーを追加
            map.addLayer(backgroundLayer);
            //スケールバー
            L.control.scale().addTo(map);
            // 背景レイヤーインスタンスを初期化
            const chiriinLayer = L.tileLayer(
                'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',  // 地理院地図のURLテンプレート
                {
                    maxZoom: 18
                },
            );
            // 地理院地図インスタンスへレイヤーを追加
            map.addLayer(chiriinLayer);
            L.control.layers({
            "OpenStreetMap": backgroundLayer,
            "地理院地図（標準）": chiriinLayer
            }).addTo(map);
            // ピン定義
            const nakamozu_marker = L.marker([34.544865,135.506274]); // ピン＝Markerを初期化
            nakamozu_marker.bindPopup('なかもずキャンパスC棟'); // ポップアップを紐付け
            map.addLayer(nakamozu_marker); // ピンを地図上に追加
            // 下のようにも書ける
            L.marker([34.592331,135.505276]).bindPopup('杉本キャンパス').addTo(map);
            
            map.attributionControl.addAttribution(
                '<a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-P29-v2_0.html">国土数値情報 - 学校データ</a>',
            );
            
            // クラスタグループの作成 
            const markers = L.markerClusterGroup();
            map.addLayer(markers);

            // GeoJSONレイヤーを作成
            fetch('./P29-21_27.geojson') // 大阪府の学校データのGeoJSONを非同期読み込み
            .then((res) => res.json())
            .then((json) => {
            // GeoJSONレイヤーを作成
            L.geoJSON(json)
            .bindPopup((layer) => layer.feature.properties.P29_004)    // ポップアップで学校名を表示
            .addTo(markers); // クラスタグループに追加
            });
            
            
            // 避難所データと地震APIの読み込み 
            
            // 避難所データ1 (緊急)
            fetch('./27000_1.geojson').then(res=>res.json()).then(json => {
                markers.addLayer(L.geoJSON(json, {
                    pointToLayer: (f, ll) => L.circleMarker(ll, {radius:8, fillColor:"green", color:"#000", weight:1, fillOpacity:0.8}),
                    onEachFeature: (f, l) => l.bindPopup("緊急避難場所: " + f.properties['施設・場所名'])
                }));
                map.fitBounds(markers.getBounds()); // データ読み込み後に全体を表示
            });

            // 避難所データ2 (指定)
            fetch('./27000_2.geojson').then(res=>res.json()).then(json => {
                markers.addLayer(L.geoJSON(json, {
                    pointToLayer: (f, ll) => L.circleMarker(ll, {radius:8, fillColor:"orange", color:"#000", weight:1, fillOpacity:0.8}),
                    onEachFeature: (f, l) => l.bindPopup("指定避難所: " + f.properties['施設・場所名'])
                }));
            });

            // API連携：P2P地震情報
            fetch('https://api.p2pquake.net/v2/history?codes=551&limit=20').then(res=>res.json()).then(data => {
                data.forEach(record => {
                    const h = record.earthquake.hypocenter;
                    if(h.latitude !== -200){
                        markers.addLayer(L.circleMarker([h.latitude, h.longitude], {
                            radius: 10, fillColor: "red", color: "#000", weight: 1, fillOpacity: 0.8
                        }).bindPopup(`<b>地震情報</b><br>発生: ${record.earthquake.time}<br>震源: ${h.name}<br>M${h.magnitude}`));
                    }
                });
            });


            // クリックで出発地・目的地を設定してルート検索します
            
            let startMarker = null, endMarker = null, routeLine = null;

            map.on('click', function(e) {
                if (startMarker && endMarker) { // リセット
                    map.removeLayer(startMarker); map.removeLayer(endMarker);
                    if (routeLine) map.removeLayer(routeLine);
                    startMarker = null; endMarker = null; routeLine = null;
                }
                if (!startMarker) { // 出発地
                    startMarker = L.marker(e.latlng).addTo(map).bindPopup("出発地").openPopup();
                } else { // 目的地＆検索
                    endMarker = L.marker(e.latlng).addTo(map).bindPopup("目的地").openPopup();
                    const url = `https://routing.openstreetmap.de/routed-car/route/v1/driving/${startMarker.getLatLng().lng},${startMarker.getLatLng().lat};${endMarker.getLatLng().lng},${endMarker.getLatLng().lat}?geometries=geojson&overview=full`;
                    fetch(url).then(r => r.json()).then(json => {
                        if(json.routes && json.routes.length > 0) {
                            if (routeLine) map.removeLayer(routeLine);
                            routeLine = L.geoJSON(json.routes[0].geometry, {color: 'blue', weight: 6, opacity: 0.7}).addTo(map);
                            const dist = (json.routes[0].distance / 1000).toFixed(1);
                            const time = (json.routes[0].duration / 60).toFixed(0);
                            endMarker.bindPopup(`目的地<br>距離: ${dist}km<br>時間: 約${time}分`).openPopup();
                        }
                    });
                }
            });
            
        </script>

        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css"
        />
        </body>
</html>